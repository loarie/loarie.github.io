<!DOCTYPE html>
<meta charset="utf-8">
<style>
body {
  background: #fcfcfa;
}

.stroke {
  fill: none;
  stroke: #000;
  stroke-width: 3px;
}

.fill {
  fill: #fff;
}

.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.land {
  fill: #222;
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}
circle {
  stroke: #fff;
}
.img-circle {
    border-radius: 50%;
}
.dot {
  fill: #cde3eb;
}
body { font-family: sans-serif; font-size: 12px;}

.butt {
   border: 1px outset #05749b;
   background-color: #cde3eb;
   height:30px;
   width:60px;
   cursor:pointer;
}

.butt_active {
  border: 1px outset #05749b;
  background-color: #05749b;
  color:white;
  height:30px;
  width:60px;
  cursor:pointer;
}

</style>
<body>
<input id="species" class="butt_active" type="button" value="Species"></input>
<input id="location" class="butt" type="button" value="Location"></input>
<script src="d3.v3.min.js"></script>
<script src="d3.geo.projection.v0.min.js"></script>
<script src="topojson.v1.min.js"></script>
<script>
var width = 500,
    height = 550,
    diameter = width,
    padding = 1; // separation between nodes

/* https://github.com/d3/d3-xhr Copyright 2015 Mike Bostock */
"undefined"==typeof Map?(Map=function(){this.clear()},Map.prototype={set:function(e,n){return this._[e]=n,this},get:function(e){return this._[e]},has:function(e){return e in this._},"delete":function(e){return e in this._&&delete this._[e]},clear:function(){this._=Object.create(null)},get size(){var e=0;for(var n in this._)++e;return e},forEach:function(e){for(var n in this._)e(this._[n],n,this)}}):function(){var e=new Map;e.set(0,0)!==e&&(e=e.set,Map.prototype.set=function(){return e.apply(this,arguments),this})}(),function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.xhr={})}(this,function(e){"use strict";function n(e){function n(e,n){var r;return t(e,function(e,t){if(r)return r(e,t-1);var o=new Function("d","return {"+e.map(function(e,n){return JSON.stringify(e)+": d["+n+"]"}).join(",")+"}");r=n?function(e,t){return n(o(e),t)}:o})}function t(e,n){function t(){if(f>=c)return i;if(o)return o=!1,u;var n=f;if(34===e.charCodeAt(n)){for(var t=n;t++<c;)if(34===e.charCodeAt(t)){if(34!==e.charCodeAt(t+1))break;++t}f=t+2;var r=e.charCodeAt(t+1);return 13===r?(o=!0,10===e.charCodeAt(t+2)&&++f):10===r&&(o=!0),e.slice(n+1,t).replace(/""/g,'"')}for(;c>f;){var r=e.charCodeAt(f++),a=1;if(10===r)o=!0;else if(13===r)o=!0,10===e.charCodeAt(f)&&(++f,++a);else if(r!==s)continue;return e.slice(n,f-a)}return e.slice(n)}for(var r,o,u={},i={},a=[],c=e.length,f=0,l=0;(r=t())!==i;){for(var p=[];r!==u&&r!==i;)p.push(r),r=t();n&&null==(p=n(p,l++))||a.push(p)}return a}function r(n){if(Array.isArray(n[0]))return o(n);var t=Object.create(null),r=[];return n.forEach(function(e){for(var n in e)(n+="")in t||r.push(t[n]=n)}),[r.map(i).join(e)].concat(n.map(function(n){return r.map(function(e){return i(n[e])}).join(e)})).join("\n")}function o(e){return e.map(u).join("\n")}function u(n){return n.map(i).join(e)}function i(e){return a.test(e)?'"'+e.replace(/\"/g,'""')+'"':e}var a=new RegExp('["'+e+"\n]"),s=e.charCodeAt(0);return{parse:n,parseRows:t,format:r,formatRows:o}}function t(e,n){return function(t){return e.parse(t.responseText,n)}}function r(e){return function(n,t){e(null==n?t:null)}}function o(e){var n=e.responseType;return n&&"text"!==n?e.response:e.responseText}function u(e){function n(e){var n=(e+="").indexOf("."),t=e;if(n>=0?e=e.slice(0,n):t+=".",e&&!i.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:t}}function t(e){return function(){for(var n,t,r=i[e],o=-1,u=r.length;++o<u;)(t=(n=r[o]).value)&&t.apply(this,arguments);return s}}var r,o=-1,u=e.length,i={},a={},s=this;for(s.on=function(e,t){if(e=n(e),arguments.length<2)return(t=a[e.name])&&t.value;if(e.type){var r,o=i[e.type],u=a[e.name];u&&(u.value=null,r=o.indexOf(u),i[e.type]=o=o.slice(0,r).concat(o.slice(r+1)),delete a[e.name]),t&&(t={value:t},a[e.name]=t,o.push(t))}else if(null==t)for(var c in i)if(t=a[c+e.name]){t.value=null;var o=i[c],r=o.indexOf(t);i[c]=o.slice(0,r).concat(o.slice(r+1)),delete a[t.name]}return s};++o<u;){if(r=e[o]+"",!r||r in s)throw new Error("illegal or duplicate type: "+r);i[r]=[],s[r]=t(r)}}function i(){return new u(arguments)}function a(e,n){function t(){var e,n=p.status;if(!n&&o(p)||n>=200&&300>n||304===n){if(s)try{e=s.call(u,p)}catch(t){return void f.error.call(u,t)}else e=p;f.load.call(u,e)}else f.error.call(u,p)}var u,a,s,c,f=i("beforesend","progress","load","error"),l=new Map,p=new XMLHttpRequest;return"undefined"==typeof XDomainRequest||"withCredentials"in p||!/^(http(s)?:)?\/\//.test(e)||(p=new XDomainRequest),"onload"in p?p.onload=p.onerror=t:p.onreadystatechange=function(){p.readyState>3&&t()},p.onprogress=function(e){f.progress.call(u,e)},u={header:function(e,n){return e=(e+"").toLowerCase(),arguments.length<2?l.get(e):(null==n?l["delete"](e):l.set(e,n+""),u)},mimeType:function(e){return arguments.length?(a=null==e?null:e+"",u):a},responseType:function(e){return arguments.length?(c=e,u):c},response:function(e){return s=e,u},get:function(e,n){return u.send("GET",e,n)},post:function(e,n){return u.send("POST",e,n)},send:function(n,t,o){return o||"function"!=typeof t||(o=t,t=null),o&&1===o.length&&(o=r(o)),p.open(n,e,!0),null==a||l.has("accept")||l.set("accept",a+",*/*"),p.setRequestHeader&&l.forEach(function(e,n){p.setRequestHeader(n,e)}),null!=a&&p.overrideMimeType&&p.overrideMimeType(a),null!=c&&(p.responseType=c),o&&u.on("error",o).on("load",function(e){o(null,e)}),f.beforesend.call(u,p),p.send(null==t?null:t),u},abort:function(){return p.abort(),u},on:function(){var e=f.on.apply(f,arguments);return e===f?u:e}},n?u.get(n):u}function s(e,n){return function(r,o,u){arguments.length<3&&(u=o,o=null);var i=a(r).mimeType(e);return i.row=function(e){return arguments.length?i.response(t(n,o=e)):o},i.row(o),u?i.get(u):i}}function c(e,n){return function(t,r){var o=a(t).mimeType(e).response(n);return r?o.get(r):o}}var f=n(" ");i.prototype=u.prototype;var l=s("text/tab-separated-values",f),p=n(","),h=s("text/csv",p),d=c("application/xml",function(e){return e.responseXML}),m=c("text/plain",function(e){return e.responseText}),v=c("application/json",function(e){return JSON.parse(e.responseText)}),g=c("text/html",function(e){return document.createRange().createContextualFragment(e.responseText)});e.xhr=a,e.html=g,e.json=v,e.text=m,e.xml=d,e.csv=h,e.tsv=l});

/* https://github.com/d3/d3-hierarchy Copyright 2015 Mike Bostock */
!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(n.hierarchy={})}(this,function(n){"use strict";function r(n){var r=[];return n.forEach(function(n){n.children&&n.children.forEach(function(e){r.push({source:n,target:e})})}),r}function e(n,e){return n.sort=function(){var r=e.sort.apply(e,arguments);return r===e?n:r},n.children=function(){var r=e.children.apply(e,arguments);return r===e?n:r},n.value=function(){var r=e.value.apply(e,arguments);return r===e?n:r},n.nodes=n,n.links=r,n}function t(n){return{x:n.x,y:n.y,dx:n.dx,dy:n.dy}}function u(n,r){var e=n.x+r[3],t=n.y+r[0],u=n.dx-r[1]-r[3],a=n.dy-r[0]-r[2];return 0>u&&(e+=u/2,u=0),0>a&&(t+=a/2,a=0),{x:e,y:t,dx:u,dy:a}}function a(n,r){for(var e=[n],t=[];null!=(n=e.pop());)if(t.push(n),(a=n.children)&&(u=a.length))for(var u,a,l=-1;++l<u;)e.push(a[l]);for(;null!=(n=t.pop());)r(n)}function l(n,r){for(var e=[n];null!=(n=e.pop());)if(r(n),(u=n.children)&&(t=u.length))for(var t,u;--t>=0;)e.push(u[t])}function i(n){return n.value}function c(n){return n.children}function o(n,r){return r.value-n.value}function f(){function n(r){var l,i=[r],c=[];for(r.parent=null,r.depth=0;null!=(l=i.pop());)if(c.push(l),(f=t.call(n,l,l.depth))&&(o=f.length)){for(var o,f,h;--o>=0;)i.push(h=f[o]),h.parent=l,h.depth=l.depth+1;u&&(l.value=0),l.children=f}else u&&(l.value=+u.call(n,l,l.depth)||0),delete l.children;return a(r,function(n){var r,t;e&&(r=n.children)&&r.sort(e),u&&(t=n.parent)&&(t.value+=n.value)}),c}var e=o,t=c,u=i;return n.nodes=n,n.links=r,n.sort=function(r){return arguments.length?(e=r,n):e},n.children=function(r){return arguments.length?(t=r,n):t},n.value=function(r){return arguments.length?(u=r,n):u},n.revalue=function(r){return u&&(l(r,function(n){n.children&&(n.value=0)}),a(r,function(r){var e;r.children||(r.value=+u.call(n,r,r.depth)||0),(e=r.parent)&&(e.value+=r.value)})),r},n}function h(){function n(n){var r=x.call(h,n,n.depth);return null==r?t(n):u(n,"number"==typeof r?[r,r,r,r]:r)}function r(n){return u(n,x)}function a(n,r){for(var e,t,u=-1,a=n.length;++u<a;)t=(e=n[u]).value*(0>r?0:r),e.area=isNaN(t)||0>=t?0:t}function l(n){var r=n.children;if(r&&r.length){var e,t,u,i=y(n),f=[],h=r.slice(),d=1/0,p="slice"===m?i.dx:"dice"===m?i.dy:"slice-dice"===m?1&n.depth?i.dy:i.dx:Math.min(i.dx,i.dy);for(a(h,i.dx*i.dy/n.value),f.area=0;(u=h.length)>0;)f.push(e=h[u-1]),f.area+=e.area,"squarify"!==m||(t=c(f,p))<=d?(h.pop(),d=t):(f.area-=f.pop().area,o(f,p,i,!1),p=Math.min(i.dx,i.dy),f.length=f.area=0,d=1/0);f.length&&(o(f,p,i,!0),f.length=f.area=0),r.forEach(l)}}function i(n){var r=n.children;if(r&&r.length){var e,t=y(n),u=r.slice(),l=[];for(a(u,t.dx*t.dy/n.value),l.area=0;e=u.pop();)l.push(e),l.area+=e.area,null!=e.z&&(o(l,e.z?t.dx:t.dy,t,!u.length),l.length=l.area=0);r.forEach(i)}}function c(n,r){for(var e,t=n.area,u=0,a=1/0,l=-1,i=n.length;++l<i;)(e=n[l].area)&&(a>e&&(a=e),e>u&&(u=e));return t*=t,r*=r,t?Math.max(r*u*_/t,t/(r*a*_)):1/0}function o(n,r,e,t){var u,a=-1,l=n.length,i=e.x,c=e.y,o=r?v(n.area/r):0;if(r==e.dx){for((t||o>e.dy)&&(o=e.dy);++a<l;)u=n[a],u.x=i,u.y=c,u.dy=o,i+=u.dx=Math.min(e.x+e.dx-i,o?v(u.area/o):0);u.z=!0,u.dx+=e.x+e.dx-i,e.y+=o,e.dy-=o}else{for((t||o>e.dx)&&(o=e.dx);++a<l;)u=n[a],u.x=i,u.y=c,u.dx=o,c+=u.dy=Math.min(e.y+e.dy-c,o?v(u.area/o):0);u.z=!1,u.dy+=e.y+e.dy-c,e.x+=o,e.dx-=o}}function h(n){var r=d||p(n),e=r[0];return e.x=0,e.y=0,e.dx=s[0],e.dy=s[1],d&&p.revalue(e),a([e],e.dx*e.dy/e.value),(d?i:l)(e),g&&(d=r),r}var d,p=f(),v=Number,s=[1,1],x=null,y=t,g=!1,m="squarify",_=V;return h.size=function(n){return arguments.length?(s=[+n[0],+n[1]],h):s.slice()},h.padding=function(e){if(!arguments.length)return Array.isArray(x)?x.slice():x;var u;return y=null==e?(x=null,t):"function"==(u=typeof e)?(x=e,n):"number"===u?(x=[e,e,e,e],r):(x=[+e[0],+e[1],+e[2],+e[3]],r),h},h.round=function(n){return arguments.length?(v=n?Math.round:Number,h):v!==Number},h.sticky=function(n){return arguments.length?(g=!!n,d=null,h):g},h.ratio=function(n){return arguments.length?(_=+n,h):_},h.mode=function(n){return arguments.length?(m=U.hasOwnProperty(n)?n+"":"squarify",h):m},e(h,p)}function d(n){var r=n.children;return r.length?r[0]:n.t}function p(n){var r,e=n.children;return(r=e.length)?e[r-1]:n.t}function v(n,r,e){return n.a.parent===r.parent?n.a:e}function s(n,r,e){var t=e/(r.i-n.i);r.c-=t,r.s+=e,n.c+=t,r.z+=e,r.m+=e}function x(n){for(var r,e=0,t=0,u=n.children,a=u.length;--a>=0;)r=u[a],r.z+=e,r.m+=e,e+=r.s+(t+=r.c)}function y(n,r){return n.parent===r.parent?1:2}function g(){function n(n,e){var i=o.call(this,n,e),f=i[0],d=r(f);if(a(d,t),d.parent.m=-d.z,l(d,u),m)l(f,c);else{var p=f,v=f,s=f;l(f,function(n){n.x<p.x&&(p=n),n.x>v.x&&(v=n),n.depth>s.depth&&(s=n)});var x=h(p,v)/2-p.x,y=g[0]/(v.x+h(v,p)/2+x),_=g[1]/(s.depth||1);l(f,function(n){n.x=(n.x+x)*y,n.y=n.depth*_})}return i}function r(n){for(var r,e={A:null,children:[n]},t=[e];null!=(r=t.pop());)for(var u,a=r.children,l=0,i=a.length;i>l;++l)t.push((a[l]=u={_:a[l],parent:r,children:(u=a[l].children)&&u.slice()||[],A:null,a:null,z:0,m:0,c:0,s:0,t:null,i:l}).a=u);return e.children[0]}function t(n){var r=n.children,e=n.parent.children,t=n.i?e[n.i-1]:null;if(r.length){x(n);var u=(r[0].z+r[r.length-1].z)/2;t?(n.z=t.z+h(n._,t._),n.m=n.z-u):n.z=u}else t&&(n.z=t.z+h(n._,t._));n.parent.A=i(n,t,n.parent.A||e[0])}function u(n){n._.x=n.z+n.parent.m,n.m+=n.parent.m}function i(n,r,e){if(r){for(var t,u=n,a=n,l=r,i=u.parent.children[0],c=u.m,o=a.m,f=l.m,x=i.m;l=p(l),u=d(u),l&&u;)i=d(i),a=p(a),a.a=n,t=l.z+f-u.z-c+h(l._,u._),t>0&&(s(v(l,n,e),n,t),c+=t,o+=t),f+=l.m,c+=u.m,x+=i.m,o+=a.m;l&&!p(a)&&(a.t=l,a.m+=f-o),u&&!d(i)&&(i.t=u,i.m+=c-x,e=n)}return e}function c(n){n.x*=g[0],n.y=n.depth*g[1]}var o=f().sort(null).value(null),h=y,g=[1,1],m=null;return n.separation=function(r){return arguments.length?(h=r,n):h},n.size=function(r){return arguments.length?(m=null==(g=r)?c:null,n):m?null:g},n.nodeSize=function(r){return arguments.length?(m=null==(g=r)?null:c,n):m?g:null},e(n,o)}function m(n){var r,e,t=n.children,u=0;if(t)for(r=0,e=t.length;e>r;++r)u=Math.max(u,m(t[r]));return 1+u}function _(n,r,e,t){var u=n.children;if(n.x=r,n.y=n.depth*t,n.dx=e,n.dy=t,u&&(a=u.length)){var a,l,i,c=-1;for(e=n.value?e/n.value:0;++c<a;)_(l=u[c],r,i=l.value*e,t),r+=i}}function k(){function n(n,e){var u=r.call(this,n,e);return _(u[0],0,t[0],t[1]/m(u[0])),u}var r=f(),t=[1,1];return n.size=function(r){return arguments.length?(t=[+r[0],+r[1]],n):t.slice()},e(n,r)}function z(n,r,e,t){var u=n.children;if(n.x=r+=t*n.x,n.y=e+=t*n.y,n.r*=t,u)for(var a=-1,l=u.length;++a<l;)z(u[a],r,e,t)}function M(n){delete n._pack_next,delete n._pack_prev}function b(n){for(var r,e=(n=n.slice()).length,t=null,u=t;e;){var a={id:n.length-e,value:n[e-1],next:null};u=u?u.next=a:t=a,n[r]=n[--e]}return{head:t,tail:u}}function q(n,r){var e=n.x-r.x,t=n.y-r.y;return Math.sqrt(e*e+t*t)<n.r-r.r+1e-6}function A(n,r,e){var t=n.x,u=n.y,a=n.r,l=r.x,i=r.y,c=r.r,o=e.x,f=e.y,h=e.r,d=2*(t-l),p=2*(u-i),v=2*(c-a),s=t*t+u*u-a*a-l*l-i*i+c*c,x=2*(t-o),y=2*(u-f),g=2*(h-a),m=t*t+u*u-a*a-o*o-f*f+h*h,_=x*p-d*y,k=(p*m-y*s)/_-t,z=(y*v-p*g)/_,M=(x*s-d*m)/_-u,b=(d*g-x*v)/_,q=z*z+b*b-1,A=2*(k*z+M*b+a),E=k*k+M*M-a*a,N=(-A-Math.sqrt(A*A-4*q*E))/(2*q);return{x:k+z*N+t,y:M+b*N+u,r:N}}function E(n,r){var e=n.x,t=n.y,u=n.r,a=r.x,l=r.y,i=r.r,c=a-e,o=l-t,f=i-u,h=Math.sqrt(c*c+o*o);return{x:(e+a+c/h*f)/2,y:(t+l+o/h*f)/2,r:(h+u+i)/2}}function N(n,r){var e,t,u,a=null,l=n.head;switch(r.length){case 1:e=r[0];break;case 2:e=E(r[0],r[1]);break;case 3:e=A(r[0],r[1],r[2])}for(;l;)u=l.value,t=l.next,e&&q(e,u)?a=l:(a?(n.tail=a,a.next=null):n.head=n.tail=null,r.push(u),e=N(n,r),r.pop(),n.head?(l.next=n.head,n.head=l):(l.next=null,n.head=n.tail=l),a=n.tail,a.next=t),l=t;return n.tail=a,e}function w(n){return N(b(n),[])}function S(n,r){var e=n._pack_next;n._pack_next=r,r._pack_prev=n,r._pack_next=e,e._pack_prev=r}function j(n,r){n._pack_next=r,r._pack_prev=n}function O(n,r){var e=r.x-n.x,t=r.y-n.y,u=n.r+r.r;return.999*u*u>e*e+t*t}function P(n,r,e){var t=n.r+e.r,u=r.x-n.x,a=r.y-n.y;if(t&&(u||a)){var l=r.r+e.r,i=u*u+a*a;l*=l,t*=t;var c=.5+(t-l)/(2*i),o=Math.sqrt(Math.max(0,2*l*(t+i)-(t-=i)*t-l*l))/(2*i);e.x=n.x+c*u+o*a,e.y=n.y+c*a-o*u}else e.x=n.x+t,e.y=n.y}function B(n){n._pack_next=n._pack_prev=n}function C(n){if((r=n.children)&&(c=r.length)){var r,e,t,u,a,l,i,c;if(r.forEach(B),e=r[0],e.x=-e.r,e.y=0,c>1&&(t=r[1],t.x=t.r,t.y=0,c>2))for(u=r[2],P(e,t,u),S(e,u),e._pack_prev=u,S(u,t),t=e._pack_next,a=3;c>a;a++){P(e,t,u=r[a]);var o=0,f=1,h=1;for(l=t._pack_next;l!==t;l=l._pack_next,f++)if(O(l,u)){o=1;break}if(1==o)for(i=e._pack_prev;i!==l._pack_prev&&!O(i,u);i=i._pack_prev,h++);o?(h>f||f==h&&t.r<e.r?j(e,t=l):j(e=i,t),a--):(S(e,u),t=u)}var u=w(r);for(a=0;c>a;++a)e=r[a],e.x-=u.x,e.y-=u.y;n.r=u.r,r.forEach(M)}}function D(n,r){return n.value-r.value}function F(){function n(n,e){var i=t.call(this,n,e),c=i[0],o=l[0],f=l[1],h=null==r?Math.sqrt:"function"==typeof r?r:function(){return r};if(c.x=c.y=0,a(c,function(n){n.r=+h(n.value)}),a(c,C),u){var d=u*(r?1:Math.max(2*c.r/o,2*c.r/f))/2;a(c,function(n){n.r+=d}),a(c,C),a(c,function(n){n.r-=d})}return z(c,o/2,f/2,r?1:1/Math.max(2*c.r/o,2*c.r/f)),i}var r,t=f().sort(D),u=0,l=[1,1];return n.size=function(r){return arguments.length?(l=[+r[0],+r[1]],n):l.slice()},n.radius=function(e){return arguments.length?(r=null==e||"function"==typeof e?e:+e,n):r},n.padding=function(r){return arguments.length?(u=+r,n):u},e(n,t)}function G(n){for(var r,e;(r=n.children)&&(e=r.length);)n=r[e-1];return n}function H(n){for(var r;(r=n.children)&&r.length;)n=r[0];return n}function I(n){return 1+n.reduce(function(n,r){return Math.max(n,r.y)},0)}function J(n){return n.reduce(function(n,r){return n+r.x},0)/n.length}function K(){function n(n,e){var i,c=r.call(this,n,e),o=c[0],f=0;a(o,function(n){var r=n.children;r&&r.length?(n.x=J(r),n.y=I(r)):(n.x=i?f+=t(n,i):0,n.y=0,i=n)});var h=H(o),d=G(o),p=h.x-t(h,d)/2,v=d.x+t(d,h)/2;return a(o,l?function(n){n.x=(n.x-o.x)*u[0],n.y=(o.y-n.y)*u[1]}:function(n){n.x=(n.x-p)/(v-p)*u[0],n.y=(1-(o.y?n.y/o.y:1))*u[1]}),c}var r=f().sort(null).value(null),t=y,u=[1,1],l=!1;return n.separation=function(r){return arguments.length?(t=r,n):t},n.size=function(r){return arguments.length?(l=null==(u=r),n):l?null:u},n.nodeSize=function(r){return arguments.length?(l=null!=(u=r),n):l?u:null},e(n,r)}function L(n){for(var r=[],e=n.parent;null!=e;)r.push(n),n=e,e=e.parent;return r.push(n),r}function Q(n,r){if(n===r)return n;var e=L(n),t=L(r),u=null;for(n=e.pop(),r=t.pop();n===r;)u=n,n=e.pop(),r=t.pop();return u}function R(n,r){for(var e=Q(n,r),t=[n];n!==e;)n=n.parent,t.push(n);for(var u=t.length;r!==e;)t.splice(u,0,r),r=r.parent;return t}function T(){return function(n){for(var r,e=-1,t=n.length,u=new Array(t);++e<t;)r=n[e],u[e]=R(r.source,r.end);return u}}var U={slice:1,dice:1,"slice-dice":1,squarify:1},V=(1+Math.sqrt(5))/2;n.bundle=T,n.cluster=K,n.links=r,n.pack=F,n.partition=k,n.tree=g,n.treemap=h});

var nil = null;
var root = {"name": "flare","children": [{"photo":"http://farm4.staticflickr.com/3233/2939911664_a9e7513df5_s.jpg","name":5212,"cname":"Red-tailed Hawk:Buteo jamaicensis","value":1,"num_obs":22},{"photo":"http://static.inaturalist.org/photos/237390/square.jpg?1444584166","name":5170,"cname":"Northern Harrier:Circus cyaneus","value":1,"num_obs":7},{"photo":"http://farm4.staticflickr.com/3235/3070052982_fc77b55b1c_s.jpg","name":4756,"cname":"Turkey Vulture:Cathartes aura","value":1,"num_obs":6},{"photo":"http://farm4.staticflickr.com/3509/3218807582_d0f545b145_s.jpg","name":5206,"cname":"Red-shouldered Hawk:Buteo lineatus","value":1,"num_obs":11},{"photo":"http://farm4.staticflickr.com/3282/3057906165_ec84bafc1d_s.jpg","name":5305,"cname":"Bald Eagle:Haliaeetus leucocephalus","value":1,"num_obs":9},{"photo":"http://static.inaturalist.org/photos/1739822/square.jpg?1444848426","name":4765,"cname":"Black Vulture:Coragyps atratus","value":1,"num_obs":3},{"photo":"http://farm3.staticflickr.com/2007/1861866801_f92c88a047_s.jpg","name":5112,"cname":"Cooper's Hawk:Accipiter cooperii","value":1,"num_obs":5},{"photo":"http://farm4.staticflickr.com/3063/2943084055_1d5b4ff63f_s.jpg","name":5277,"cname":"White-tailed Kite:Elanus leucurus","value":1,"num_obs":6},{"photo":"http://farm4.staticflickr.com/3112/3181667427_5acdb3986d_s.jpg","name":5097,"cname":"Sharp-shinned Hawk:Accipiter striatus","value":1,"num_obs":1},{"photo":"http://farm2.staticflickr.com/1313/3267798008_47e8110cd7_s.jpg","name":5200,"cname":"Rough-legged Hawk:Buteo lagopus","value":1,"num_obs":2},{"photo":"http://farm4.staticflickr.com/3304/4553558773_b1251dde00_s.jpg","name":5178,"cname":"Pale Harrier:Circus macrourus","value":1,"num_obs":1},{"photo":"http://farm4.staticflickr.com/3637/3406106176_98f05429c0_s.jpg","name":201041,"cname":"Roadside Hawk:Rupornis magnirostris","value":1,"num_obs":1},{"photo":"http://farm4.staticflickr.com/3337/3667337685_ae23b2d560_s.jpg","name":5180,"cname":"Zone-tailed Hawk:Buteo albonotatus","value":1,"num_obs":1},{"photo":"http://farm1.staticflickr.com/139/326753913_05932ebbd3_s.jpg","name":116999,"cname":"Osprey:Pandion haliaetus","value":1,"num_obs":5},{"photo":"http://farm3.staticflickr.com/2439/3555236216_40f10ed702_s.jpg","name":5233,"cname":"Common Black-Hawk:Buteogallus anthracinus","value":1,"num_obs":1},{"photo":"http://farm4.staticflickr.com/3617/3409931750_d70164c3ab_s.jpg","name":5301,"cname":"Swallow-tailed Kite:Elanoides forficatus","value":1,"num_obs":1}]};
var dat = [{"image_url":"73807-thumb.jpg","user_login":"butterflies4fun","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"33.0934897222","lon":"-96.6415047222"},{"image_url":"defaults/thumb.png","user_login":"gbentall","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"36.838047","lon":"-121.79549"},{"image_url":"defaults/thumb.png","user_login":"gbentall","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"36.837068","lon":"-121.798666"},{"image_url":"defaults/thumb.png","user_login":"gbentall","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"36.798083","lon":"-121.789058"},{"image_url":"13979-thumb.jpg","user_login":"robberfly","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.76693","lon":"-122.4729533333"},{"image_url":"13979-thumb.jpg","user_login":"robberfly","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"37.7663533333","lon":"-122.4710533333"},{"image_url":"13979-thumb.jpg","user_login":"robberfly","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"37.74803","lon":"-122.4585583333"},{"image_url":"27263-thumb.jpg","user_login":"wendy5","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"48.138923","lon":"-122.801474"},{"image_url":"127188-thumb.jpg","user_login":"kimberlietx","taxon_id":4765,"taxon_name":"Black Vulture:Coragyps atratus","lat":"32.64642","lon":"-97.153656"},{"image_url":"1000-thumb.jpg","user_login":"muir","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"39.271553","lon":"-75.47477"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5112,"taxon_name":"Cooper's Hawk:Accipiter cooperii","lat":"38.343337","lon":"-122.696933"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"38.347242","lon":"-122.64309"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"38.349405","lon":"-122.644141"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"38.349085","lon":"-122.647735"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"38.345014","lon":"-122.643315"},{"image_url":"12610-thumb.jpg","user_login":"susanelliott","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"28.908134","lon":"-81.799861"},{"image_url":"43895-thumb.jpg","user_login":"rehb","taxon_id":5097,"taxon_name":"Sharp-shinned Hawk:Accipiter striatus","lat":"32.8294896216","lon":"-96.9146301232"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.1565929745","lon":"-121.6153982236"},{"image_url":"9434-thumb.jpg","user_login":"taogirl","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"32.876652","lon":"-97.173058"},{"image_url":"9434-thumb.jpg","user_login":"taogirl","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"32.87631","lon":"-97.170698"},{"image_url":"28-thumb.jpg","user_login":"tiwane","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"37.87502","lon":"-122.31812"},{"image_url":"28-thumb.jpg","user_login":"tiwane","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.87507","lon":"-122.3181716667"},{"image_url":"31792-thumb.jpg","user_login":"aaroncarlson","taxon_id":5200,"taxon_name":"Rough-legged Hawk:Buteo lagopus","lat":"43.1656844799","lon":"-89.36113152"},{"image_url":"31792-thumb.jpg","user_login":"aaroncarlson","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"43.1602173","lon":"-89.36246938"},{"image_url":"8778-thumb.jpg","user_login":"gyrrlfalcon","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"26.989395","lon":"-81.732273"},{"image_url":"124900-thumb.jpg","user_login":"emilyd47","taxon_id":5112,"taxon_name":"Cooper's Hawk:Accipiter cooperii","lat":"33.916681","lon":"-117.90006"},{"image_url":"34719-thumb.jpg","user_login":"rbbrummitt","taxon_id":5200,"taxon_name":"Rough-legged Hawk:Buteo lagopus","lat":"51.125506","lon":"-114.473419"},{"image_url":"161606-thumb.jpg","user_login":"setibarbara","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"37.431671","lon":"-122.087502"},{"image_url":"defaults/thumb.png","user_login":"kellkeenan","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"47.445236","lon":"-122.457588"},{"image_url":"defaults/thumb.png","user_login":"nikborrow","taxon_id":5178,"taxon_name":"Pale Harrier:Circus macrourus","lat":"52.9887288984","lon":"0.4077700673"},{"image_url":"5327-thumb.jpg","user_login":"direbecca","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"38.093388","lon":"-122.735306"},{"image_url":"100132-thumb.jpg","user_login":"angel92_yucatanjay","taxon_id":201041,"taxon_name":"Roadside Hawk:Rupornis magnirostris","lat":"20.597936322","lon":"-88.1518010795"},{"image_url":"100132-thumb.jpg","user_login":"angel92_yucatanjay","taxon_id":5180,"taxon_name":"Zone-tailed Hawk:Buteo albonotatus","lat":"20.5371800244","lon":"-88.0720392545"},{"image_url":"8778-thumb.jpg","user_login":"gyrrlfalcon","taxon_id":116999,"taxon_name":"Osprey:Pandion haliaetus","lat":"26.8459838777","lon":"-82.2676403672"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"36.898354","lon":"-121.80503"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"36.898354","lon":"-121.80503"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"36.898354","lon":"-121.80503"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"36.898354","lon":"-121.80503"},{"image_url":"112646-thumb.jpg","user_login":"fatroosterfarm","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"43.852917","lon":"-72.588713"},{"image_url":"2873-thumb.jpg","user_login":"jmaughn","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"36.968176","lon":"-122.021396"},{"image_url":"88577-thumb.jpg","user_login":"nelruzam","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"38.58463","lon":"-122.700242"},{"image_url":"defaults/thumb.png","user_login":"phylocode","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"49.288502","lon":"-123.039075"},{"image_url":"2991-thumb.jpg","user_login":"sea-kangaroo","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"37.389697","lon":"-122.173376"},{"image_url":"2991-thumb.jpg","user_login":"sea-kangaroo","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.389493","lon":"-122.175136"},{"image_url":"2991-thumb.jpg","user_login":"sea-kangaroo","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.384583","lon":"-122.177582"},{"image_url":"2991-thumb.jpg","user_login":"sea-kangaroo","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"37.384583","lon":"-122.177582"},{"image_url":"21626-thumb.jpg","user_login":"francisco3","taxon_id":null,"taxon_name":"Hawks and Buzzards:Buteo","lat":"23.299","lon":"-106.44343"},{"image_url":"9531-thumb.jpg","user_login":"kucycads","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"30.103873","lon":"-97.278442"},{"image_url":"defaults/thumb.png","user_login":"corvid81","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"29.371479","lon":"-95.628525"},{"image_url":"defaults/thumb.png","user_login":"bobmcd","taxon_id":5112,"taxon_name":"Cooper's Hawk:Accipiter cooperii","lat":"48.445371","lon":"-123.315222"},{"image_url":"17932-thumb.jpg","user_login":"treichard","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"39.3032413065","lon":"-76.8712549891"},{"image_url":"52839-thumb.jpg","user_login":"glmory","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"33.6988963889","lon":"-118.0454380556"},{"image_url":"64015-thumb.jpg","user_login":"gzepeda","taxon_id":5112,"taxon_name":"Cooper's Hawk:Accipiter cooperii","lat":"19.3389359482","lon":"-99.0702149052"},{"image_url":"4530-thumb.jpg","user_login":"jay","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus hudsonius","lat":"40.95318","lon":"-111.935427"},{"image_url":"defaults/thumb.png","user_login":"taraneier","taxon_id":5277,"taxon_name":"White-tailed Kite:Elanus leucurus","lat":"37.873241","lon":"-120.999126"},{"image_url":"defaults/thumb.png","user_login":"ross2","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"37.4658883333","lon":"-122.2874966667"},{"image_url":"160043-thumb.jpg","user_login":"muddler","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"48.028355","lon":"-123.139435"},{"image_url":"1213-thumb.jpg","user_login":"dave-barry","taxon_id":5206,"taxon_name":"California Red-shouldered Hawk:Buteo lineatus elegans","lat":"38.416258","lon":"-122.813684"},{"image_url":"54843-thumb.jpg","user_login":"thewayfarer21","taxon_id":4765,"taxon_name":"Black Vulture:Coragyps atratus","lat":"34.514653","lon":"-77.484341"},{"image_url":"defaults/thumb.png","user_login":"lauraelviauribelara","taxon_id":116999,"taxon_name":"Osprey:Pandion haliaetus","lat":"20.406695","lon":"-100.078332"},{"image_url":"defaults/thumb.png","user_login":"lauraelviauribelara","taxon_id":5233,"taxon_name":"Common Black-Hawk:Buteogallus anthracinus","lat":"20.3244982408","lon":"-100.1442592431"},{"image_url":"defaults/thumb.png","user_login":"nanorca13","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"49.275015","lon":"-124.117291"},{"image_url":"9434-thumb.jpg","user_login":"taogirl","taxon_id":5112,"taxon_name":"Cooper's Hawk:Accipiter cooperii","lat":"32.886408","lon":"-97.282962"},{"image_url":"22589-thumb.jpg","user_login":"sambiology","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"32.768172","lon":"-97.684231"},{"image_url":"22589-thumb.jpg","user_login":"sambiology","taxon_id":4765,"taxon_name":"Black Vulture:Coragyps atratus","lat":"32.767964","lon":"-97.683895"},{"image_url":"8778-thumb.jpg","user_login":"gyrrlfalcon","taxon_id":116999,"taxon_name":"Osprey:Pandion haliaetus","lat":"26.9087072423","lon":"-82.2962001292"},{"image_url":"8778-thumb.jpg","user_login":"gyrrlfalcon","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"26.9420359579","lon":"-82.2086113435"},{"image_url":"3342-thumb.jpg","user_login":"hfabian","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.975165","lon":"-121.824903"},{"image_url":"3342-thumb.jpg","user_login":"hfabian","taxon_id":4756,"taxon_name":"Turkey Vulture:Cathartes aura","lat":"37.975165","lon":"-121.824903"},{"image_url":"3342-thumb.jpg","user_login":"hfabian","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"37.9202431057","lon":"-121.8542206768"},{"image_url":"3342-thumb.jpg","user_login":"hfabian","taxon_id":116999,"taxon_name":"Osprey:Pandion haliaetus","lat":"37.9332866277","lon":"-121.8061115273"},{"image_url":"defaults/thumb.png","user_login":"royaltyler","taxon_id":116999,"taxon_name":"Osprey:Pandion haliaetus","lat":"30.230916483","lon":"-87.4801711613"},{"image_url":"78791-thumb.jpg","user_login":"itmndeborah","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"32.439815","lon":"-96.934605"},{"image_url":"13979-thumb.jpg","user_login":"robberfly","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"37.7662283333","lon":"-122.4696666667"},{"image_url":"79924-thumb.jpg","user_login":"matty","taxon_id":5206,"taxon_name":"California Red-shouldered Hawk:Buteo lineatus elegans","lat":"36.4919566667","lon":"-121.7438033333"},{"image_url":"13979-thumb.jpg","user_login":"robberfly","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"37.77092","lon":"-122.47882"},{"image_url":"defaults/thumb.png","user_login":"mayfly1963","taxon_id":null,"taxon_name":"Hawks, Eagles, Vultures, and Allies:Accipitriformes","lat":"35.507125","lon":"-93.315884"},{"image_url":"defaults/thumb.png","user_login":"mayfly1963","taxon_id":5305,"taxon_name":"Bald Eagle:Haliaeetus leucocephalus","lat":"35.574958164","lon":"-93.2620366076"},{"image_url":"125469-thumb.jpg","user_login":"jerikson","taxon_id":5301,"taxon_name":"Swallow-tailed Kite:Elanoides forficatus","lat":"-0.0659313652","lon":"-78.7805962935"},{"image_url":"100322-thumb.jpg","user_login":"salmonskyview","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"48.425879","lon":"-123.467734"},{"image_url":"10787-thumb.jpg","user_login":"maractwin","taxon_id":5170,"taxon_name":"Northern Harrier:Circus cyaneus","lat":"42.7752983333","lon":"-70.8067033333"},{"image_url":"10787-thumb.jpg","user_login":"maractwin","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"42.846005","lon":"-70.9153983333"},{"image_url":"10787-thumb.jpg","user_login":"maractwin","taxon_id":5212,"taxon_name":"Red-tailed Hawk:Buteo jamaicensis","lat":"42.7985683333","lon":"-70.813195"},{"image_url":"124900-thumb.jpg","user_login":"emilyd47","taxon_id":5206,"taxon_name":"Red-shouldered Hawk:Buteo lineatus","lat":"33.915001","lon":"-117.905946"}]
var taxon_array = dat.map(function(d){return d.taxon_id;});
var arrayUnique = function(a) {
    return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
    }, []);
};
function cleanArray(actual) {
  var newArray = new Array();
  for (var i = 0; i < actual.length; i++) {
    if (actual[i]) {
      newArray.push(actual[i]);
    }
  }
  return newArray;
};
var raw_m = cleanArray(arrayUnique(taxon_array));
var m = raw_m.length; // number of distinct clusters
var data = dat.concat(raw_m.map(function(d){return {taxon_id: d, login: null}}));

var diameter = 500,
    format = d3.format(",d");

var pack = hierarchy.pack()
        .size([diameter, diameter])
        .value(function(d) { return d.value; });

var res = pack.nodes(root);
var centroids = res.filter(function(d){return d.depth == 1;})
var radius =  12//(centroids.filter(function(d){return d.value == 1;}).length > 0) ? centroids.filter(function(d){return d.value == 1;})[0].r : ((centroids.filter(function(d){return d.value == 2;}).length > 0) ? centroids.filter(function(d){return d.value == 2;})[0].r/2 : ((centroids.filter(function(d){return d.value == 3;}).length > 0) ? centroids.filter(function(d){return d.value == 3;})[0].r/2 : 14));

var color = d3.scale.category10()
    .domain(d3.range(m));

var counts_raw_m = {};
for(var i = 0; i< dat.length; i++) {
    var num = dat[i].taxon_id;
    counts_raw_m[num] = counts_raw_m[num] ? counts_raw_m[num]+1 : 1;
}

var nodes = data.map(function(d) { //add to object
  if(d.user_login == null){
    return {
      image_url: centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].photo,
      name: root.children[root.children.map(function(d){return d.name}).indexOf(d.taxon_id)].cname,
      login: null,
      taxon_id: d.taxon_id,
      radius: centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].r,
      fixed: true,
      x: (d.taxon_id == null ? width/2 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].x),
      y: (d.taxon_id == null ? 600 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].y),
      lat: null,
      lon: null,
      cx: (d.taxon_id == null ? width/2 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].x),
      cy: (d.taxon_id == null ? 600 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].y)
    };
  }else{
    return {
      image_url: d.image_url,
      name: d.taxon_name,
      login: d.user_login,
      taxon_id: d.taxon_id,
      fixed: false,
      radius: radius*2*.6,// + (Math.random()-.5)*20,
      lat: d.lat,
      lon: d.lon,
      cx: (d.taxon_id == null ? width/2 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].x),
      cy: (d.taxon_id == null ? 600 : centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].y)
    };
  }
});

var force = d3.layout.force()
    .nodes(nodes)
    .size([width, height])
    .gravity(0)
    //.charge(function(d) { return d.login == null ? -Math.pow(centroids[centroids.map(function(d){return d.name;}).indexOf(d.taxon_id)].r/10,2) : 0; })
    .charge(function(d) { return d.login == null ? -1 : 0; })
    .on("tick", tick)
    .start();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var projection = d3.geo.kavrayskiy7()
    .scale(90)
    .translate([width / 2, height / 2])
    .precision(.1);

var path = d3.geo.path()
    .projection(projection);

var graticule = d3.geo.graticule();

svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path)
    .attr("visibility","hidden");

svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere");

svg.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");

svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path)
    .attr("visibility","hidden");

d3.json("world-50m.json", function(error, world) {
  if (error) throw error;

  var countries = topojson.feature(world, world.objects.countries).features,
      neighbors = topojson.neighbors(world.objects.countries.geometries);

  svg.selectAll(".country")
      .data(countries)
    .enter().insert("path", ".graticule")
      .attr("class", "country")
      .attr("d", path)
      .style("fill", "#cde3eb")
      .attr("visibility","hidden");

  svg.insert("path", ".graticule")
      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
      .attr("class", "boundary")
      .attr("d", path)
      .attr("visibility","hidden");
});

var c = svg.selectAll(".node")
    .data(res)
    .enter().append("g").filter(function(d) { return d.name != "flare"; })
    .attr("class", "centroid")
    .attr("taxon_id", function(d){ return d.name; })
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
  c.append("circle")
    .attr("class","dot")
    .attr("id",function(d) { return "c"+d.name; })
    .attr("r",function(d) { return d.r; });

var node = svg.selectAll(".node")
    .data(nodes)
  .enter().append("g")
    .attr("class", function(d) { return d.fixed ? "icon" : "obs"; })
    .attr("name", function(d) { return d.name; })
    .attr("taxon_id", function(d) { return d.taxon_id; })
    .attr("login", function(d) { return d.login; })
.on("mouseover", mouseover)
.on("mouseout", mouseout)
    
    
    node.filter(function(d) { return !d.fixed; })
    .call(force.drag);
    
    node.append("circle")
      .attr("class","image_border")
      .attr("r",function(d) { return d.radius/2; })
      .attr("cx",function(d) { return 0; })
      .attr("cy",function(d) { return 0; })
      .style("fill-opacity", function(d) { return d.fixed ? "0" : "1"; })
      .style("stroke-opacity", function(d) { return d.fixed ? "0" : "1"; })
      .style("fill", "#fff")
      .style("stroke-width", "2");
    node
      .append("clipPath")
      .attr("id","clipCircle")
      .append("circle")
      .attr("r",function(d) { return d.radius/2; })
      .attr("cx",function(d) { return 0; })
      .attr("cy",function(d) { return 0; });
    node
      .append("image")
      .attr("xlink:href", function(d) { if(d.image_url == "defaults/thumb.png"){
        return "https://www.inaturalist.org/attachment_defaults/users/icons/defaults/thumb.png";
      }else{
        if(d.fixed){
          return d.image_url;
        }else{
          return "https://www.inaturalist.org/attachments/users/icons/"+d.image_url;
        }
      }})
      .attr("x", function(d) { return -d.radius/2; })
      .attr("y", function(d) { return -d.radius/2; })
      .attr("width", function(d) { return d.radius; })
      .attr("height", function(d) { return d.radius; })
      .attr("class","img-circle")
      .attr("clip-path","url(#clipCircle)");


      var box = svg.append("g").attr("class","box").attr("visibility","hidden");
      var common_name = box.append("text")
          .attr("class","common_name")
          .attr("x", diameter*.5)
          .attr("y", diameter)
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
        .text("A very long text box as a placeholder for a very long name");
      
      var login = box.append("text")
          .attr("class","login")
          .attr("x", diameter*.5)
          .attr("y", diameter+20)
          .attr("dy", ".35em")
          .attr("text-anchor", "middle");
      
      var bbox = common_name.node().getBBox();

      var rect = box.append("rect")
              .attr("x", bbox.x-10/2)
              .attr("y", bbox.y-15)
              .attr("width", bbox.width+10)
              .attr("height", bbox.height+50)
              .style("fill", "#fff")
              .style("fill-opacity", ".3")
              .style("stroke-width", "1.5px");


function tick(e) {
  node
      .each(gravity(.1 * e.alpha))
      .each(collide(0.2))
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}

// Move nodes toward cluster focus.
function gravity(alpha) {
  return function(d) {
    d.y += (d.cy - d.y) * alpha;
    d.x += (d.cx - d.x) * alpha;
  };
}

// Resolve collisions between nodes.
function collide(alpha) {
  var quadtree = d3.geom.quadtree(nodes);
  return function(d) {
    var r = d.radius,
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    quadtree.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d)) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.radius*.7;
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
  };
}

d3.select("input#species").on("click", go_species);
d3.select("input#location").on("click", go_location);

function go_species() {
  var button = d3.select("input#species");
  if(button.attr("class")=="butt_active"){return;}
  
  button.attr("class","butt_active");
  var other_button = d3.select("input#location");
  other_button.attr("class","butt");
  
  force.stop();
  new_nodes = raw_m.map(function(d){return {
    image_url: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].photo,
    taxon_id: d,
    login: null,
    name: root.children[root.children.map(function(d){return d.name}).indexOf(d)].cname,
    radius: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].r,
    fixed: true,
    x: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].x,
    y: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].y,
    lat: null,
    lon: null,
    cx: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].x,
    cy: centroids[centroids.map(function(d){return d.name;}).indexOf(d)].y
  }});
  for(var i in new_nodes){
    nodes.push(new_nodes[i]);
  }
    
  node = node.data(force.nodes(), function(d,i) { return i;});
  var newn = node.enter().append("g")
      .attr("class", function(d) { return d.fixed ? "icon" : "obs"; })
      .attr("name", function(d) { return d.name; })
      .attr("login", function(d) { return d.login; })
      .attr("taxon_id", function(d) { return d.taxon_id; })
      .on("mouseover", mouseover)
      .on("mouseout", mouseout);
    
  newn.append("circle")
            .attr("class","image_border")
            .attr("r",function(d) { return d.radius/2; })
            .attr("cx",function(d) { return 0; })
            .attr("cy",function(d) { return 0; })
            .style("fill-opacity", function(d) { return d.fixed ? "0" : "1"; })
            .style("stroke-opacity", function(d) { return d.fixed ? "0" : "1"; })
            .style("fill", "#fff")
            .style("stroke-width", "2");
  newn.append("clipPath")
            .attr("id","clipCircle")
            .append("circle")
            .attr("r",function(d) { return d.radius/2; })
            .attr("cx",function(d) { return 0; })
            .attr("cy",function(d) { return 0; });
  newn.append("image")
            .attr("xlink:href", function(d) { if(d.image_url == "defaults/thumb.png"){
              return "https://www.inaturalist.org/attachment_defaults/users/icons/defaults/thumb.png";
            }else{
              if(d.fixed){
                return d.image_url;
              }else{
                return "https://www.inaturalist.org/attachments/users/icons/"+d.image_url;
              }
            }})
            .attr("x", function(d) { return -d.radius/2; })
            .attr("y", function(d) { return -d.radius/2; })
            .attr("width", function(d) { return d.radius; })
            .attr("height", function(d) { return d.radius; })
            .attr("class","img-circle")
            .attr("clip-path","url(#clipCircle)");

  force.start();
  for (var i in nodes) {
      nodes[i].cx = (nodes[i].taxon_id == null ? width/2 : centroids[centroids.map(function(d){return d.name;}).indexOf(nodes[i].taxon_id)].x);
      nodes[i].cy = (nodes[i].taxon_id == null ? 600 : centroids[centroids.map(function(d){return d.name;}).indexOf(nodes[i].taxon_id)].y);
      if(nodes[i].login != null){
        nodes[i].radius = radius*2*.6;
      }else{
        
      }
  }
  d3.selectAll("g.centroid").attr("visibility","visible");
  d3.selectAll("#sphere").attr("visibility","hidden");
  d3.selectAll(".graticule").attr("visibility","hidden");
  d3.selectAll(".boundary").attr("visibility","hidden");
  d3.selectAll(".country").attr("visibility","hidden");
}
  
function go_location() {  
  var button = d3.select("input#location");
  if(button.attr("class")=="butt_active"){return;}
  button.attr("class","butt_active");
  var other_button = d3.select("input#species");
  other_button.attr("class","butt");
  
  force.stop();
  nodes.splice(dat.length, m);
  node = node.data(force.nodes(), function(d,i) { return i;});
  node.exit().remove();
      
  for (var i in nodes) {
      if(nodes[i].lon != null){
        coords = projection([parseInt(nodes[i].lon),parseInt(nodes[i].lat)]);
        nodes[i].cx = coords[0];
        nodes[i].cy = coords[1];
      }
      if(nodes[i].login != null){
        nodes[i].radius = 0;
      }
  }
  force.start();
  d3.selectAll("g.centroid").attr("visibility","hidden");
  d3.selectAll(".boundary").attr("visibility","visible");
  d3.selectAll(".country").attr("visibility","visible");
    
}


function mouseover(d) {
  this.parentNode.appendChild(this);
  
  group = d3.select(this);
  group.select('circle.image_border')
    .style("stroke-width", "2px")
    .style("stroke", "#05749b");
    
    var common_name = group.attr("name");
    var infobox = svg.select("g.box");
    var someDom = infobox[0][0];
    someDom.parentNode.appendChild(someDom);
    
    infobox.style("visibility","visible")
    var cname = infobox.select("text.common_name").text("");
    cname.append("svg:tspan").text(common_name.split(":")[0]+" (");
    cname.append("svg:tspan").style("font-style","italic").text(common_name.split(":")[1]);      
    cname.append("svg:tspan").text(")");
    
    infobox.select("rect").style("stroke", "#05749b");
    if(group.attr("class")=="obs"){
      var login = group.attr("login");
      infobox.select("text.login")
        .text("observed by "+login);
    }else{
      var taxon_id = group.attr("taxon_id");
      var num_obs = root.children[root.children.map(function(d){return d.name}).indexOf(parseInt(taxon_id))].num_obs
      var cname = infobox.select("text.login").text("");
      cname.append("svg:tspan").style("font-weight","bold").text(num_obs);   
      cname.append("svg:tspan").text(" observation" + (parseInt(num_obs) > 1 ? "s" : ""));
      
      circ = svg.selectAll("circle#c"+taxon_id);
      circ.style("fill","#05749b");
    }
  
}

function mouseout(d) {
  this.parentNode.appendChild(this);
  
  group = d3.select(this);
  group.select('circle.image_border')
  .style("stroke-width", "1px")
  .style("stroke", "#fff");
  
  var infobox = svg.select("g.box");
  var someDom = infobox[0][0];
  someDom.parentNode.appendChild(someDom);
  infobox.style("visibility","hidden");
  
  circ = svg.selectAll("circle.dot");
  circ.style("fill","#cde3eb")
}



</script>